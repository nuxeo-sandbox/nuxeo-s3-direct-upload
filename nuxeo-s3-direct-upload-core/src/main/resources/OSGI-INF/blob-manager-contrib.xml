<component name="org.nuxeo.ecm.platform.aws.s3.refstorage" version="1.0.0">
  <require>org.nuxeo.ecm.core.storage.cloud.managment.contrib</require>

  <!-- the KVBStore rely on a KVStore and BlobProvider with the same name s3kvs -->
  <extension target="org.nuxeo.ecm.core.transientstore.TransientStorageComponent" point="store">
    <store name="s3kvs" class="org.nuxeo.ecm.core.transientstore.keyvalueblob.KeyValueBlobTransientStore">
      <targetMaxSizeMB>10000</targetMaxSizeMB>
      <absoluteMaxSizeMB>-1</absoluteMaxSizeMB>
      <firstLevelTTL>120</firstLevelTTL>
      <secondLevelTTL>10</secondLevelTTL>
    </store>
  </extension>

  <!-- the kv for properties -->
  <extension target="org.nuxeo.runtime.kv.KeyValueService" point="configuration">
    <store name="s3kvs" class="org.nuxeo.runtime.kv.MemKeyValueStore"></store>
  </extension>

  <!-- the blob provider use iam role -->
  <extension target="org.nuxeo.ecm.core.blob.BlobManager" point="configuration">
    <blobprovider name="s3kvs">
      <class>org.nuxeo.ecm.core.storage.sql.S3BinaryManager</class>
      <property name="awsid"></property>
      <property name="awssecret"></property>
      <property name="region">eu-west-1</property>
      <property name="bucket">nuxeo-b10b-upload</property>
      <property name="bucket.prefix">/</property>
      <property name="directdownload">true</property>
      <property name="cachesize">-1</property>
      <property name="connection.max">50</property>
      <property name="connection.retry">3</property>
      <property name="connection.timeout">120000</property>
      <property name="socket.timeout">120000</property>
    </blobprovider>
  </extension>

  <!-- batch handler for direct s3 upload -->
  <extension target="org.nuxeo.ecm.automation.server.BatchManager" point="handlers">
    <batchHandler>
      <name>s3</name>
      <class>org.nuxeo.s3.S3DirectBatchHandler</class>
      <property name="transientStore">s3kvs</property>
      <property name="awsSecretKeyId"></property>
      <property name="awsSecretAccessKey"></property>
      <property name="awsRegion">eu-west-1</property>
      <property name="awsBucket">nuxeo-b10b-upload</property>
      <property name="roleArn">arn:aws:iam::820410587685:role/JenkinsRole</property>
      <property name="s3AccelerationSupported">true</property>
    </batchHandler>
  </extension>

  <!-- hack to dispatch providers ? -->
  <extension target="org.nuxeo.ecm.core.blob.DocumentBlobManager" point="configuration">
    <blobdispatcher>
      <class>org.nuxeo.ecm.core.blob.DefaultBlobDispatcher</class>
      <property name="fakeschema:fakeprop=fakevalue">s3kvs</property>
      <property name="default">default</property>
    </blobdispatcher>
  </extension>

</component>
